<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ORCID Login and Data Retrieval Demo</title>
    <script src="https://kjur.github.io/jsrsasign/jsrsasign-latest-all-min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        #userInfo, #orcidData { display: none; }
    </style>
</head>
<body>
    <a href="#" id="login">Sign into ORCID</a>
    <div id="userInfo">
        <h3>User Information:</h3>
        <p id="name"></p>
        <p id="orcidId"></p>
        <button id="logout">Logout</button>
    </div>
    <div id="orcidData">
        <h3>ORCID Data:</h3>
        <p id="biography"></p>
        <div id="works"></div>
    </div>

    <script>
        var clientId = "APP-FFRGVFLKABJ1F4R5";
        var orcidAuthUrl = "https://orcid.org/oauth/authorize";
        var redirectUri = "https%3A%2F%2Fjlumbroso.github.io%2Forcid-login-demo%2F";

        var globRecord = null;

        function getFragmentParameterByName(name) {
            var regex = new RegExp("[#&]" + name + "=([^&]*)"),
                results = regex.exec(window.location.hash);
            return results ? decodeURIComponent(results[1]) : null;
        }

        function fetchOrcidData(orcidId, accessToken) {
            var url = "https://pub.orcid.org/v3.0/" + orcidId + "/record";

            $.ajax({
                url: url,
                headers: {
                    'Accept': 'application/json',
                    'Authorization': 'Bearer ' + accessToken
                },
                success: function(data) {
                    displayOrcidData(data);
                    globRecord = data;
                },
                error: function() {
                    $("#orcidData").text("Error retrieving ORCID data.");
                }
            });
        }

        function formatRecordToHtml(jsonString) {
            // Parse the JSON string
            const record = JSON.parse(jsonString);

            // Extract the necessary fields
            const startYear = record['start-date']?.year?.value || 'Unknown';
            const endYear = record['end-date'] ? record['end-date'].year.value : 'current';
            const roleTitle = record['role-title'] || 'Unknown Role';
            const organizationName = record.organization?.name || 'Unknown Organization';

            // Construct the HTML string
            const html = `<li>(
                <span class="yearStart">${startYear}</span>-
                <span class="yearEnd">${endYear}</span>) 
                <span class="workTitle">${roleTitle}</span>, 
                <span class="workOrg">${organizationName}</span>
            </li>`;

            return html;
        }


        function displayOrcidData(data) {
            if (data.person && data.person.biography) {
                $("#biography").text("Biography: " + data.person.biography.content);
            }
            if (data["activities-summary"] && data["activities-summary"]["employments"] && data["activities-summary"]["employments"]["affiliation-group"]) {
                var works = data["activities-summary"]["employments"]["affiliation-group"];
                var worksList = works.map(function(workGroup) {
                    var personData = workGroup['summaries'][0]["employment-summary"];
                    return formatRecordToHtml(JSON.stringify(personData));
                }).join("");
                $("#works").html("<ul>" + worksList + "</ul>");
            }
        }

        $(document).ready(function() {
            var accessToken = getFragmentParameterByName("access_token");

            if (accessToken) {
                $("#login").hide();
                $("#userInfo").show();
                $.ajax({
                    url: 'https://orcid.org/oauth/userinfo',
                    headers: { 'Authorization': 'Bearer ' + accessToken },
                    success: function(data) {
                        $("#name").text("Name: " + data.given_name + " " + data.family_name);
                        $("#orcidId").text("ORCID ID: " + data.sub);
                        fetchOrcidData(data.sub, accessToken);
                    },
                    error: function() {
                        $("#name").text("Error retrieving user info.");
                    }
                });
            } else {
                $("#login").attr("href", orcidAuthUrl + "?response_type=token&redirect_uri=" + redirectUri + "&client_id=" + clientId + "&scope=openid&nonce=whatever");
            }

            $("#logout").click(function() {
                window.location.hash = '';
                window.location.reload();
            });
        });
    </script>
</body>
</html>
